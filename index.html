<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Generator QR – MECARD (PNG)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f8fafc;color:#0f172a}
    .wrap{max-width:1000px;margin:0 auto;padding:24px}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:16px;padding:16px}
    .grid{display:grid;gap:16px}
    @media(min-width:880px){.grid{grid-template-columns:1fr 1fr}}
    label{display:block;font-size:13px;color:#475569;margin-bottom:4px}
    input,select,textarea{width:100%;box-sizing:border-box;border:1px solid #e2e8f0;border-radius:12px;padding:10px;font-size:14px;outline:none}
    button{border:1px solid #0f172a;border-radius:12px;padding:10px 14px;background:#0f172a;color:#fff;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    #preview{display:flex;align-items:center;justify-content:center;min-height:260px;border:1px dashed #e2e8f0;border-radius:12px}
    .hint{font-size:12px;color:#64748b}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    img{max-width:100%;height:auto;border-radius:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:0 0 12px">Generator QR (MECARD) – obraz PNG</h1>
    <p class="hint" style="margin:0 0 16px">Wpisz dane → kliknij „Generuj QR”. Obrazek zawsze się pojawi (bez zewnętrznych bibliotek). Jeśli nie widzisz zmian, wciśnij <b>Ctrl/Cmd+Shift+R</b>.</p>

    <div class="grid">
      <section class="card">
        <div class="grid">
          <div>
            <label>Imię *</label>
            <input id="firstName" placeholder="Michał">
          </div>
          <div>
            <label>Nazwisko *</label>
            <input id="lastName" placeholder="Okoń">
          </div>

          <div class="grid" style="grid-template-columns:1fr 1fr">
            <div>
              <label>Telefon</label>
              <input id="phone" placeholder="+48600123456">
            </div>
            <div>
              <label>E-mail</label>
              <input id="email" placeholder="kontakt@twojadomena.pl">
            </div>
          </div>

          <div>
            <label>Firma</label>
            <input id="org" placeholder="TS Invest">
          </div>
          <div>
            <label>Stanowisko</label>
            <input id="title" placeholder="UX/UI Designer">
          </div>
          <div>
            <label>Strona www</label>
            <input id="url" placeholder="https://twojadomena.pl">
          </div>

          <div class="row" style="margin-top:6px">
            <button id="genBtn">Generuj QR</button>
            <button id="dlBtn" disabled>Pobierz PNG</button>
            <button id="copyBtn" disabled>Kopiuj MECARD</button>
          </div>
          <p class="hint">W MECARD znaki <code>\ ; : ,</code> są automatycznie „ucieczone”.</p>
          <div id="err" class="hint" style="color:#b91c1c;display:none"></div>
        </div>
      </section>

      <section class="card">
        <h3 style="margin:0 0 10px">Podgląd</h3>
        <div id="preview"></div>

        <div style="margin-top:12px">
          <label>Wynikowy MECARD</label>
          <textarea id="mecardOut" class="mono" rows="4" readonly></textarea>
        </div>

        <div style="margin-top:12px" class="grid" >
          <div>
            <label>Rozmiar QR</label>
            <select id="qrSize">
              <option>256</option>
              <option selected>320</option>
              <option>384</option>
              <option>448</option>
            </select>
          </div>
          <div>
            <label>Korekcja błędów</label>
            <select id="qrEcc">
              <option value="L">L</option>
              <option value="M" selected>M</option>
              <option value="Q">Q</option>
              <option value="H">H</option>
            </select>
          </div>
        </div>
        <p class="hint" style="margin-top:6px">Do wizytówki zwykle wystarczy 20–25 mm i ECC M/Q (zostaw „quiet zone”).</p>
      </section>
    </div>
  </div>

  <script>
    // Escapowanie wg MECARD
    function esc(v=""){return v.replace(/\\/g,"\\\\").replace(/;/g,"\\;").replace(/:/g,"\\:").replace(/,/g,"\\,").trim()}
    function normPhone(v=""){return v.replace(/[^\d+;]/g,"")}
    function buildMECARD(f){
      const pts=[];
      const ln=esc(f.lastName), fn=esc(f.firstName);
      if (ln||fn) pts.push(`N:${ln}${ln&&fn?",":""}${fn}`);
      if (f.org)   pts.push(`ORG:${esc(f.org)}`);
      if (f.title) pts.push(`TITLE:${esc(f.title)}`);
      const tel=normPhone(f.phone); if (tel) pts.push(`TEL:${tel}`);
      if (f.email) pts.push(`EMAIL:${esc(f.email)}`);
      if (f.url)   pts.push(`URL:${esc(f.url)}`);
      return `MECARD:${pts.join(";")};;`;
    }

    const eccMap = { L: 'L', M: 'M', Q: 'Q', H: 'H' }; // dla Google API
    const preview = document.getElementById('preview');
    const out = document.getElementById('mecardOut');
    const genBtn = document.getElementById('genBtn');
    const dlBtn = document.getElementById('dlBtn');
    const copyBtn = document.getElementById('copyBtn');
    const err = document.getElementById('err');

    let lastPngUrl = null; // URL obrazka QR (Google)
    let lastCanvasDataUrl = null; // zrenderowane lokalnie do pobrania

    function generateQR(){
      err.style.display='none'; err.textContent='';
      const f={
        firstName:document.getElementById('firstName').value,
        lastName: document.getElementById('lastName').value,
        phone:    document.getElementById('phone').value,
        email:    document.getElementById('email').value,
        org:      document.getElementById('org').value,
        title:    document.getElementById('title').value,
        url:      document.getElementById('url').value
      };
      if(!f.firstName || !f.lastName){
        alert('Podaj co najmniej imię i nazwisko.'); return;
      }

      const mecard = buildMECARD(f);
      out.value = mecard;

      const size = parseInt(document.getElementById('qrSize').value,10) || 320;
      const ecc  = eccMap[document.getElementById('qrEcc').value] || 'M';

      // Google Chart Image API (PNG)
      // chs = size x size, chld = ECC|margin(0), chl = payload
      const url = `https://chart.googleapis.com/chart?cht=qr&chs=${size}x${size}&chld=${ecc}|0&chl=${encodeURIComponent(mecard)}`;
      lastPngUrl = url;

      // Wyrenderuj podgląd i przygotuj do pobierania
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => {
        preview.innerHTML = "";
        preview.appendChild(img);
        // render do canvas -> dataURL, by pobieranie było lokalne
        const canvas = document.createElement('canvas');
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        try {
          lastCanvasDataUrl = canvas.toDataURL('image/png');
          dlBtn.disabled = false;
          copyBtn.disabled = false;
        } catch(e){
          // nawet jeśli się nie uda, pozwól pobrać bezpośrednio źródło
          lastCanvasDataUrl = null;
          dlBtn.disabled = false;
          copyBtn.disabled = false;
        }
      };
      img.onerror = () => {
        err.style.display='block';
        err.textContent='Nie udało się wczytać obrazka QR. Spróbuj ponownie (lub wyłącz blokery).';
      };
      img.src = url;
    }

    function downloadPNG(){
      if(lastCanvasDataUrl){
        const a = document.createElement('a');
        a.href = lastCanvasDataUrl;
        a.download = 'mecard-qr.png';
        a.click();
      } else if (lastPngUrl){
        // fallback – bezpośredni PNG z Google
        const a = document.createElement('a');
        a.href = lastPngUrl;
        a.download = 'mecard-qr.png';
        a.click();
      }
    }

    async function copyMECARD(){
      try{
        await navigator.clipboard.writeText(out.value);
        copyBtn.textContent='Skopiowano ✔';
        setTimeout(()=>copyBtn.textContent='Kopiuj MECARD',1200);
      }catch{
        alert('Nie udało się skopiować do schowka.');
      }
    }

    genBtn.addEventListener('click', generateQR);
    dlBtn.addEventListener('click', downloadPNG);
    copyBtn.addEventListener('click', copyMECARD);

    // przykładowe wartości
    document.getElementById('firstName').value='Michał';
    document.getElementById('lastName').value='Okoń';
    document.getElementById('org').value='TS Invest';
    document.getElementById('title').value='UX/UI Designer';
    document.getElementById('phone').value='+48600123456';
    document.getElementById('email').value='kontakt@twojadomena.pl';
    document.getElementById('url').value='https://twojadomena.pl';
  </script>
</body>
</html>
