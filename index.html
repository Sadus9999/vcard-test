<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Generator QR – MECARD</title>
  <!-- QRCode.js (bez integrity, prosto z cdnjs) -->
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f8fafc;color:#0f172a}
    .wrap{max-width:1000px;margin:0 auto;padding:24px}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:16px;padding:16px}
    .grid{display:grid;gap:16px}
    @media(min-width:880px){.grid{grid-template-columns:1fr 1fr}}
    label{display:block;font-size:13px;color:#475569;margin-bottom:4px}
    input,select,textarea{width:100%;box-sizing:border-box;border:1px solid #e2e8f0;border-radius:12px;padding:10px;font-size:14px;outline:none}
    button{border:1px solid #0f172a;border-radius:12px;padding:10px 14px;background:#0f172a;color:#fff;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    #qrcode{display:flex;align-items:center;justify-content:center;min-height:260px;border:1px dashed #e2e8f0;border-radius:12px}
    .hint{font-size:12px;color:#64748b}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:0 0 12px">Generator QR (MECARD)</h1>
    <p class="hint" style="margin:0 0 16px">Wpisz dane i wygeneruj kod QR działający na iOS i Androidzie. Jeśli nie widzisz QR, wciśnij <b>Ctrl/Cmd+Shift+R</b> (twarde odświeżenie).</p>

    <div class="grid">
      <section class="card">
        <div class="grid">
          <div>
            <label>Imię *</label>
            <input id="firstName" placeholder="Imię">
          </div>
          <div>
            <label>Nazwisko *</label>
            <input id="lastName" placeholder="Nazwisko">
          </div>

          <div class="grid" style="grid-template-columns:1fr 1fr">
            <div>
              <label>Telefon</label>
              <input id="phone" placeholder="+48 numer">
            </div>
            <div>
              <label>E-mail</label>
              <input id="email" placeholder="kontakt@twojadomena.pl">
            </div>
          </div>

          <div>
            <label>Firma</label>
            <input id="org" placeholder="TS Invest">
          </div>
          <div>
            <label>Stanowisko</label>
            <input id="title" placeholder="UX/UI Designer">
          </div>
          <div>
            <label>Strona www</label>
            <input id="url" placeholder="https://twojadomena.pl">
          </div>

          <div class="row" style="margin-top:6px">
            <button id="genBtn">Generuj QR</button>
            <button id="dlBtn" disabled>Pobierz PNG</button>
            <button id="copyBtn" disabled>Kopiuj MECARD</button>
          </div>
          <div id="err" class="hint" style="color:#b91c1c;display:none"></div>
        </div>
      </section>

      <section class="card">
        <h3 style="margin:0 0 10px">Podgląd</h3>
        <div id="qrcode"></div>

        <div style="margin-top:12px">
          <label>Wynikowy MECARD</label>
          <textarea id="mecardOut" class="mono" rows="4" readonly></textarea>
        </div>

        <div style="margin-top:12px" class="grid" >
          <div>
            <label>Rozmiar QR</label>
            <select id="qrSize">
              <option>256</option>
              <option selected>320</option>
              <option>384</option>
              <option>448</option>
            </select>
          </div>
          <div>
            <label>Korekcja błędów</label>
            <select id="qrEcc">
              <option value="L">L</option>
              <option value="M" selected>M</option>
              <option value="Q">Q</option>
              <option value="H">H</option>
            </select>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // Zaczekaj aż biblioteka się załaduje (defer+DOMContentLoaded)
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof QRCode === 'undefined') {
        const err = document.getElementById('err');
        err.style.display = 'block';
        err.textContent = 'Błąd: biblioteka QRCode.js się nie załadowała. Sprawdź blokady (uBlock/NoScript) lub odśwież stronę twardo (Ctrl/Cmd+Shift+R).';
        return;
      }

      // --- UTF-8 helper (klucz do polskich znaków) ---
      function toUTF8(s){ return unescape(encodeURIComponent(s)); }

      // Escapowanie wg MECARD
      function esc(v=""){return v.replace(/\\/g,"\\\\").replace(/;/g,"\\;").replace(/:/g,"\\:").replace(/,/g,"\\,").trim()}
      function normPhone(v=""){return v.replace(/[^\d+;]/g,"")}
      function buildMECARD(f){
        const pts=[];
        const ln=esc(f.lastName), fn=esc(f.firstName);
        if (ln||fn) pts.push(`N:${ln}${ln&&fn?",":""}${fn}`);
        if (f.org)   pts.push(`ORG:${esc(f.org)}`);
        if (f.title) pts.push(`TITLE:${esc(f.title)}`);
        const tel=normPhone(f.phone); if (tel) pts.push(`TEL:${tel}`);
        if (f.email) pts.push(`EMAIL:${esc(f.email)}`);
        if (f.url)   pts.push(`URL:${esc(f.url)}`);
        return `MECARD:${pts.join(";")};;`;
      }

      const eccMap={L:QRCode.CorrectLevel.L,M:QRCode.CorrectLevel.M,Q:QRCode.CorrectLevel.Q,H:QRCode.CorrectLevel.H};
      const qrcodeEl=document.getElementById('qrcode');
      const out=document.getElementById('mecardOut');
      const genBtn=document.getElementById('genBtn');
      const dlBtn=document.getElementById('dlBtn');
      const copyBtn=document.getElementById('copyBtn');
      let qr=null;

      function gen() {
  const f = {
    firstName: document.getElementById('firstName').value,
    lastName:  document.getElementById('lastName').value,
    phone:     document.getElementById('phone').value,
    email:     document.getElementById('email').value,
    org:       document.getElementById('org').value,
    title:     document.getElementById('title').value,
    url:       document.getElementById('url').value
  };
  if (!f.firstName || !f.lastName) { alert('Podaj co najmniej imię i nazwisko.'); return; }

  // Helpery z Twojego kodu (muszą istnieć wyżej):
  // - toUTF8(s)
  // - buildMECARD(f)

  const mecard = buildMECARD(f);
  out.value = mecard;

  // ustawienia z UI
  const sizeSelect = document.getElementById('qrSize');
  const basePx  = parseInt(sizeSelect.value, 10) || 320;

  // ECC -> litera dla qrcode-generator (L/M/Q/H)
  // Żeby zmaksymalizować pojemność, bierzemy L; jak chcesz, możesz czytać z selecta.
  const eccLetter = 'L';

  // Spróbuj rosnących "typeNumber" = większa wersja QR (większa pojemność)
  const tryTypes = [10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40];

  let made = false;
  let qr = null;

  for (const t of tryTypes) {
    try {
      // qrcode(typeNumber, errorCorrectLevel)
      qr = qrcode(t, eccLetter);
      // Dodaj dane jako bajty (UTF-8)
      qr.addData(toUTF8(mecard), 'Byte');
      qr.make(); // <- jeśli za mała wersja, tu poleci wyjątek
      made = true;
      break;
    } catch (e) {
      // próbujemy większą wersję
      continue;
    }
  }

  const errBox = document.getElementById('err');
  qrcodeEl.innerHTML = "";

  if (!made) {
    errBox.style.display = 'block';
    errBox.textContent = 'Nawet największa wersja QR (40, ECC L) nie mieści danych. Skróć URL/stanowisko/firme.';
    dlBtn.disabled = true;
    copyBtn.disabled = false; // kopiowanie tekstu niech działa
    return;
  }

  // Render: przerysuj macierz QR na <canvas> o żądanej wielkości w px
  const count = qr.getModuleCount();
  const pxPerModule = Math.floor(basePx / count) || 1;
  const sizePx = pxPerModule * count;

  const canvas = document.createElement('canvas');
  canvas.width = sizePx;
  canvas.height = sizePx;
  const ctx = canvas.getContext('2d');

  // tło białe
  ctx.fillStyle = '#fff';
  ctx.fillRect(0,0,sizePx,sizePx);
  // moduły
  ctx.fillStyle = '#000';
  for (let r = 0; r < count; r++) {
    for (let c = 0; c < count; c++) {
      if (qr.isDark(r, c)) {
        ctx.fillRect(c * pxPerModule, r * pxPerModule, pxPerModule, pxPerModule);
      }
    }
  }

  qrcodeEl.appendChild(canvas);

  // włącz przyciski
  dlBtn.disabled = false;
  copyBtn.disabled = false;

  // schowaj ewentualny error
  errBox.style.display = 'none';
  errBox.textContent = '';
}


      function downloadPNG(){
        if(!qr) return;
        const canvas=qrcodeEl.querySelector('canvas');
        const img=qrcodeEl.querySelector('img');
        const link=document.createElement('a'); link.download='mecard-qr.png';
        if(canvas){ link.href=canvas.toDataURL('image/png'); link.click(); return; }
        if(img && img.src){ link.href=img.src; link.click(); }
      }

      async function copyMECARD(){
        try{ await navigator.clipboard.writeText(out.value); copyBtn.textContent='Skopiowano ✔'; setTimeout(()=>copyBtn.textContent='Kopiuj MECARD',1200);}
        catch{ alert('Nie udało się skopiować do schowka.'); }
      }

      genBtn.addEventListener('click', gen);
      dlBtn.addEventListener('click', downloadPNG);
      copyBtn.addEventListener('click', copyMECARD);

      // Starter values (możesz zmienić)
   
    });
  </script>
</body>
</html>
